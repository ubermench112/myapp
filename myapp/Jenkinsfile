pipeline {
  agent any

  environment {
    SUBDIR = "myapp"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Install Python deps') {
      steps {
        dir("${SUBDIR}") {
          bat """
          python -m venv venv
          call venv\\Scripts\\activate
          pip install --upgrade pip
          pip install -r requirements.txt
          """
        }
      }
    }

    stage('Smoke Test') {
      steps {
        dir("${SUBDIR}") {
          bat """
          call venv\\Scripts\\activate
          python -c "print('Python is working inside Jenkins')"
          """
        }
      }
    }

    stage('Docker Build') {
      steps {
        dir("${SUBDIR}") {
          bat """
          docker build -t myapp:latest .
          """
        }
      }
    }

    stage('Deploy') {
      steps {
        bat """
        docker run -d -p 8081:5000 --name myapp_container myapp:latest
        """
      }
    }
  }
}
